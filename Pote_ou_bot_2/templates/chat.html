<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <link href="static/css/chat.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>

    <script>
        let role; // Déclaration de la variable role à l'extérieur de la fonction
    
        function checkForAutoMessage() {
            fetch('/get_messages')
                .then(response => response.json())
                .then(data => {
                    const messages = data.messages;
                    const autoMessage = messages.find(message => message.content === "Premier arrivé (devineur).");
                    if (autoMessage) {
                        fetch('/save_ordre_arrivee', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: 'pos=2'
                        }).then(response => {
                            if (response.ok) {
                                response.text().then(newRole => {
                                    role = newRole; // Affectation de la valeur de newRole à la variable role
                                    showPopup(role);
                                    initializeChat(); // Appel à initializeChat() après avoir obtenu le rôle
                                });
                            }
                        });
                    } else {
                        fetch('/save_ordre_arrivee', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: 'pos=1'
                        }).then(response => {
                            if (response.ok) {
                                response.text().then(newRole => {
                                    role = newRole; // Affectation de la valeur de newRole à la variable role
                                    sendAutomaticMessage();
                                    showPopup(role);
                                    initializeChat(); // Appel à initializeChat() après avoir obtenu le rôle
                                });
                            }
                        });
                    }
                });
        }
    
        function showPopup(role) {
            alert("Vous êtes le " + role + ".");
        }
    
        function sendAutomaticMessage() {
            const defaultMessage = "Premier arrivé (devineur)."; // Message par défaut à envoyer automatiquement
            fetch('/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `message=${encodeURIComponent(defaultMessage)}`
            });
        }
    
        function initializeChat() {
            // Fonction pour vérifier si l'utilisateur actuel est le devineur
            function isDevineur() {
                return role === 'devineur';
            }

            // Fonction pour vérifier si l'utilisateur actuel est le pote
            function isPote() {
                return role === 'pote';
            }

            // Fonction pour vérifier si l'utilisateur actuel est le bot
            function isBot() {
                return role === 'bot';
            }
    
            // Variable pour stocker le temps restant avant l'envoi du prochain message
            let remainingTime = isDevineur() ? 0 : (isPote() ? 20000 : 0); // Initialiser le temps restant à 20000 pour le pote, sinon 0
    
            // Fonction pour actualiser les messages affichés dans le chat
            function refreshMessages() {
                fetch('/get_messages')
                    .then(response => response.json())
                    .then(data => {
                        const messages = data.messages;
                        const chatMessages = document.getElementById('chat-messages');
                        chatMessages.innerHTML = ''; // Effacer
                        messages.forEach(message => {
                            const messageElement = document.createElement('div');
                            messageElement.textContent = `${message.author}: ${message.content}`;
                            chatMessages.appendChild(messageElement);
                        });
                    });
            }
    
            // Fonction pour envoyer un message
            function sendMessage(message) {
                fetch('/send_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `message=${encodeURIComponent(message)}`
                });
            }
    
            // Fonction pour bloquer l'interface
            function blockInterface() {
                document.getElementById('message-input').disabled = true;
                document.querySelector('button[type="submit"]').disabled = true;
            }
    
            // Fonction pour débloquer l'interface
            function unblockInterface() {
                document.getElementById('message-input').disabled = false;
                document.querySelector('button[type="submit"]').disabled = false;
            }

            // Fonction pour gérer le flux de messages entre le devineur et le pote
            function messageFlow() {
                // Si l'utilisateur actuel est le devineur
                if (isDevineur()) {
                    unblockInterface(); // Débloquer l'interface pour le devineur
                    // Démarrer le compte à rebours pour le devineur seulement s'il envoie un message
                    document.getElementById('message-form').addEventListener('submit', function(event) {
                        event.preventDefault(); // Empêcher le comportement par défaut du formulaire
                        sendMessage(document.getElementById('message-input').value);
                        document.getElementById('message-input').value = ''; // Effacer l'input après envoi
                        blockInterface(); // Bloquer l'interface après l'envoi du message
                        // Démarrer le compte à rebours uniquement pour le premier message du devineur
                        let countdown = setInterval(() => {
                            remainingTime += 1000;
                            if (remainingTime >= 20000) {
                                clearInterval(countdown);
                                remainingTime = 0; // Réinitialiser le temps restant pour le devineur
                            }
                        }, 1000);
                    });
                } else if (isPote()) { // Si l'utilisateur actuel est le pote
                    // Bloquer l'interface pour le pote
                    blockInterface();
                    // Démarrer le compte à rebours pour le pote
                    let countdown = setInterval(() => {
                        remainingTime -= 1000;
                        if (remainingTime <= 0) {
                            clearInterval(countdown);
                            unblockInterface(); // Débloquer l'interface pour le pote après le délai
                            remainingTime = 20000; // Réinitialiser le temps restant pour le prochain délai
                        }
                    }, 1000);
                } else if (isBot()) { // Si l'utilisateur actuel est le bot
                    // Bloquer l'interface pour le bot
                    blockInterface();
                }
            }
    
            // Initialiser l'actualisation des messages
            refreshMessages();
            setInterval(refreshMessages, 1000); // Actualiser les messages toutes les secondes

            // Démarrer le flux de messages
            messageFlow();
        }
    
        // Événement lorsque la page est chargée
        window.addEventListener('load', checkForAutoMessage);
    </script>
</head>

<body>

    <h2>Vous êtes en chat avec {{ contact_username }}... OU UN ROBOT QUI SAIT ?!</h2>
    <div id="chat-messages">
        <!-- Messages -->
    </div>
    <form id="message-form">
        <input type="text" id="message-input" placeholder="Tapez votre message">
        <button type="submit">Envoyer</button>
    </form>

    <script>
        // Fonction pour bloquer l'interface
        function blockInterface() {
            document.getElementById('message-input').disabled = true;
            document.querySelector('button[type="submit"]').disabled = true;
        }
    
        // Fonction pour débloquer l'interface
        function unblockInterface() {
            document.getElementById('message-input').disabled = false;
            document.querySelector('button[type="submit"]').disabled = false;
        }
    </script>

</body>

</html>
