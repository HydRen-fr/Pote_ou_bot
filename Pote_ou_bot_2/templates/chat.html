<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <link href="static/css/chat.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>

    <script>
        let role; // Déclaration de la variable role à l'extérieur de la fonction
        let isFormSubmitted = false; // Variable pour suivre si le formulaire a été soumis

        function checkForAutoMessage() {
            fetch('/get_messages')
                .then(response => response.json())
                .then(data => {
                    const messages = data.messages;
                    const autoMessage = messages.find(message => message.content === "Premier arrivé (devineur).");
                    if (autoMessage) {
                        fetch('/save_ordre_arrivee', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: 'pos=2'
                        }).then(response => {
                            if (response.ok) {
                                response.text().then(newRole => {
                                    role = newRole; // Affectation de la valeur de newRole à la variable role
                                    showPopup(role);
                                    initializeChat(); // Appel à initializeChat() après avoir obtenu le rôle
                                });
                            }
                        });
                    } else {
                        fetch('/save_ordre_arrivee', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: 'pos=1'
                        }).then(response => {
                            if (response.ok) {
                                response.text().then(newRole => {
                                    role = newRole; // Affectation de la valeur de newRole à la variable role
                                    sendAutomaticMessage();
                                    showPopup(role);
                                    initializeChat(); // Appel à initializeChat() après avoir obtenu le rôle
                                });
                            }
                        });
                    }
                });
        }
    
        function showPopup(role) {
            alert("Vous êtes le " + role + ".");
        }
    
        function sendAutomaticMessage() {
            const defaultMessage = "Premier arrivé (devineur)."; // Message par défaut à envoyer automatiquement
            fetch('/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `message=${encodeURIComponent(defaultMessage)}`
            });
        }
    
        function initializeChat() {
            // Fonction pour vérifier si l'utilisateur actuel est le devineur
            function isDevineur() {
                return role === 'devineur';
            }

            // Fonction pour vérifier si l'utilisateur actuel est le pote
            function isPote() {
                return role === 'pote';
            }
    
            // Variable pour stocker le temps restant avant l'envoi du prochain message
            let remainingTime = isDevineur() ? 20000 : 0; // Initialiser le temps restant à 0 pour le devineur, sinon 20000
    
            // Fonction pour actualiser les messages affichés dans le chat
            function refreshMessages() {
                fetch('/get_messages')
                    .then(response => response.json())
                    .then(data => {
                        const messages = data.messages;
                        const chatMessages = document.getElementById('chat-messages');
                        chatMessages.innerHTML = ''; // Effacer
                        messages.forEach(message => {
                            const messageElement = document.createElement('div');
                            messageElement.textContent = `${message.author}: ${message.content}`;
                            chatMessages.appendChild(messageElement);
                        });
                    });
            }
    
            // Fonction pour envoyer un message
            function sendMessage(message) {
                fetch('/send_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `message=${encodeURIComponent(message)}`
                });
            }
    
            // Fonction pour bloquer l'interface
            function blockInterface() {
                document.getElementById('message-input').disabled = true;
                document.querySelector('button[type="submit"]').disabled = true;
            }
    
            // Fonction pour débloquer l'interface
            function unblockInterface() {
                document.getElementById('message-input').disabled = false;
                document.querySelector('button[type="submit"]').disabled = false;
            }

            // Fonction pour gérer le flux de messages entre le devineur et le pote
            function messageFlow() {
                // Si l'utilisateur actuel est le devineur
                if (isDevineur()) {
                    // Démarrer le compte à rebours pour le devineur
                    let countdown = setInterval(() => {
                        remainingTime -= 1000;
                        if (remainingTime <= 0) {
                            clearInterval(countdown);
                            // Envoyer le message du devineur et débloquer l'interface
                            sendMessage(document.getElementById('message-input').value);
                            unblockInterface();
                        }
                    }, 1000);
                }
                // Si l'utilisateur actuel est le pote
                else if (isPote()) {
                    // Débloquer l'interface du pote
                    unblockInterface();
                }
            }
    
            // Actualiser les messages toutes les secondes
            refreshMessages();
            setInterval(refreshMessages, 1000);
    
            // Gérer le flux de messages
            messageFlow();
        }
    
        window.addEventListener('load', checkForAutoMessage);
    
        // Événement lorsque le formulaire de message est soumis
        document.getElementById('message-form').addEventListener('submit', function(event) {
            if (!isFormSubmitted) { // Si le formulaire n'a pas encore été soumis
                event.preventDefault(); // Empêcher le comportement par défaut du formulaire
                sendMessage(document.getElementById('message-input').value);
                document.getElementById('message-input').value = ''; // Effacer l'input après envoi
                blockInterface(); // Bloquer l'interface après l'envoi du message
                isFormSubmitted = true; // Mettre à jour isFormSubmitted pour arrêter d'écouter l'événement submit
            }
        });
    </script>

</head>

<body>

    <h2>Vous êtes en chat avec {{ contact_username }}... OU UN ROBOT QUI SAIT ?!</h2>
    <div id="chat-messages">
        <!-- Messages -->
    </div>
    <form id="message-form">
        <input type="text" id="message-input" placeholder="Tapez votre message">
        <button type="submit">Envoyer</button>
    </form>

</body>

</html>
